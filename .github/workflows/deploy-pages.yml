name: deploy-pages
run-name: Building and deploying to GitHub pages
on: [push]
jobs:
  deploy-pages:
    runs-on: self-hosted
    steps:
      - name: Build and deploy to pages
        shell: bash
        env:
          ENVIRONMENT: ${{ secrets.ENVIRONMENT }}
        run: |
          echo "=========================================" 2>&1 | tee /dev/tty
          echo "Starting deployment at $(date)" 2>&1 | tee /dev/tty
          echo "=========================================" 2>&1 | tee /dev/tty

          echo "Cleaning up old scottv.dev directory..." 2>&1 | tee /dev/tty
          if [ -d "./scottv.dev" ]; then rm -Rf ./scottv.dev; fi

          echo "Cloning repository..." 2>&1 | tee /dev/tty
          git clone https://github.com/vandents/scottv.dev.git 2>&1 | tee /dev/tty
          cd scottv.dev

          echo "Installing dependencies..." 2>&1 | tee /dev/tty
          npm i 2>&1 | tee /dev/tty

          echo "Setting environment variables..." 2>&1 | tee /dev/tty
          npx ts-node ./src/set-env.ts "$ENVIRONMENT" 2>&1 | tee /dev/tty

          echo "Building application..." 2>&1 | tee /dev/tty
          npm run build 2>&1 | tee /dev/tty

          cd ..

          echo "Cleaning up old scottv-pages directory..." 2>&1 | tee /dev/tty
          if [ -d "./scottv-pages" ]; then rm -Rf ./scottv-pages; fi

          echo "Cloning gh-pages branch..." 2>&1 | tee /dev/tty
          git clone https://github.com/vandents/scottv.dev.git scottv-pages 2>&1 | tee /dev/tty
          cd scottv-pages
          git checkout gh-pages 2>&1 | tee /dev/tty

          echo "Removing old files from gh-pages..." 2>&1 | tee /dev/tty
          rm -r * 2>&1 | tee /dev/tty

          echo "Copying new build files..." 2>&1 | tee /dev/tty
          mv ../scottv.dev/dist/browser/* ./ 2>&1 | tee /dev/tty
          cp index.html 404.html 2>&1 | tee /dev/tty

          echo "Committing changes..." 2>&1 | tee /dev/tty
          git add -A 2>&1 | tee /dev/tty
          git commit -m "Uploading from self-hosted runner at $(date)" 2>&1 | tee /dev/tty

          echo "Pushing to GitHub..." 2>&1 | tee /dev/tty
          git push 2>&1 | tee /dev/tty

          echo "=========================================" 2>&1 | tee /dev/tty
          echo "Deployment completed at $(date)" 2>&1 | tee /dev/tty
          echo "=========================================" 2>&1 | tee /dev/tty
